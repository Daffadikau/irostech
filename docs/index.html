<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CBRN Tactical Command System</title>
    <link rel="icon" type="image/png" href="./assets/tab-logo.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <style>
      :root {
        --bg: #0a0f0d;
        --panel: #101915;
        --panel-2: #0f1412;
        --accent: #38ff9c;
        --accent-2: #00d4ff;
        --warning: #ffb020;
        --critical: #ff4d4f;
        --text: #e6f4ee;
        --muted: #8aa39b;
        --border: #1f2a25;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .app {
        display: grid;
        grid-template-columns: 260px 1fr;
        min-height: 100vh;
      }

      .sidebar {
        background: #0b120f;
        border-right: 1px solid var(--border);
        padding: 24px 18px;
      }

      .brand {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        font-weight: 700;
        letter-spacing: 0.6px;
        text-align: center;
      }

      .brand-logo {
        width: 120px;
        height: 32px;
        object-fit: contain;
        background: #ffffff;
        border-radius: 8px;
        padding: 4px 8px;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);
      }

      .brand > div {
        font-size: 14px;
        line-height: 1.3;
      }

      .brand-badge {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: linear-gradient(135deg, #1d3f2b, #1a7f50);
        display: grid;
        place-items: center;
        color: var(--accent);
        font-weight: 700;
      }

      .nav {
        margin-top: 28px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .nav button {
        background: transparent;
        border: 1px solid transparent;
        color: var(--muted);
        text-align: left;
        padding: 12px 14px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .nav button.active,
      .nav button:hover {
        border-color: var(--border);
        color: var(--text);
        background: var(--panel);
      }

      .content {
        padding: 24px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .status-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #0f1f17;
        border: 1px solid var(--border);
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }

      .grid {
        display: grid;
        gap: 16px;
      }

      .grid.two {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .grid.three {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--shadow);
      }

      .panel h3 {
        margin: 0 0 12px;
        font-size: 16px;
        letter-spacing: 0.4px;
      }

      .panel p {
        margin: 0;
        color: var(--muted);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 6px 10px;
        border: 1px solid var(--border);
        font-size: 12px;
        color: var(--muted);
      }

      .map-layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 320px;
        gap: 16px;
      }

      .map-area {
        background: linear-gradient(135deg, #0f1a14, #12241a);
        border: 1px solid var(--border);
        border-radius: 18px;
        min-height: 520px;
        height: 520px;
        position: relative;
        overflow: hidden;
        z-index: 0;
      }

      #map {
        width: 100%;
        height: 100%;
        border-radius: 18px;
      }

      .map-overlay {
        position: absolute;
        top: 16px;
        right: 16px;
        left: auto;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        pointer-events: none;
        z-index: 9999;
        max-width: calc(100% - 32px);
      }

      .map-overlay.bottom-left {
        top: auto;
        right: auto;
        left: 16px;
        bottom: 16px;
      }

      .map-overlay.bottom-right {
        top: auto;
        right: 16px;
        left: auto;
        bottom: 16px;
      }

      .map-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        pointer-events: auto;
      }

      .map-layer-group {
        display: flex;
        gap: 4px;
      }

      .map-controls button,
      .map-control-btn,
      .btn {
        background: #0e1512;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
      }

      .map-control-btn.active {
        background: var(--accent);
        color: #000;
        border-color: var(--accent);
        font-weight: 600;
      }

      .map-controls button:hover,
      .map-control-btn:hover {
        border-color: var(--accent);
      }

      .panel-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .panel-actions .btn,
      .panel-actions .map-control-btn {
        font-size: 12px;
        padding: 6px 10px;
      }

      .timeline {
        display: grid;
        gap: 8px;
      }

      .timeline-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--panel-2);
      }

      .timeline-meta {
        color: var(--muted);
        font-size: 12px;
      }

      .role-selector {
        background: #0e1512;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 10px;
      }

      .notification-list {
        display: grid;
        gap: 8px;
      }

      .notification-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--panel-2);
      }

      .tag-muted {
        color: var(--muted);
        font-size: 12px;
      }

      .map-title {
        font-weight: 600;
        letter-spacing: 0.4px;
      }

      .sidebar-panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
      }

      .telemetry {
        display: grid;
        gap: 10px;
      }

      .telemetry-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--panel-2);
        font-size: 13px;
      }

      .severity {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent);
      }

      .dot.critical {
        background: var(--critical);
      }

      .dot.high {
        background: #ff7a45;
      }

      .dot.medium {
        background: var(--warning);
      }

      .dot.low {
        background: #3fa9f5;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .table th,
      .table td {
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
      }

      .table th {
        color: var(--muted);
        font-weight: 500;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 12px;
        color: var(--muted);
      }

      .list {
        display: grid;
        gap: 10px;
      }

      .list-item {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--panel-2);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .split {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
      }

      .section {
        display: none;
      }

      .section.active {
        display: block;
      }

      .badge {
        padding: 4px 8px;
        border-radius: 6px;
        background: #102116;
        border: 1px solid var(--border);
        color: var(--accent);
        font-size: 11px;
      }

      .danger {
        background: #2a0f0f;
        border-color: #4a1f1f;
        color: #ff8f8f;
      }

      @media (max-width: 1100px) {
        .app {
          grid-template-columns: 1fr;
        }

        .sidebar {
          position: sticky;
          top: 0;
          z-index: 2;
          display: flex;
          align-items: center;
          gap: 16px;
          overflow-x: auto;
        }

        .nav {
          flex-direction: row;
          margin: 0;
        }

        .map-layout,
        .split,
        .grid.two,
        .grid.three {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">
          <img class="brand-logo" src="./irostech-logo.png" alt="Irostech logo" />
          <div>
            <div>CBRN Tactical</div>
            <div class="tag">Command System</div>
          </div>
        </div>
        <nav class="nav" aria-label="Primary">
          <button class="active" data-section="overview">Command Map</button>
          <button data-section="analysis">Analysis</button>
          <button data-section="substances">CBRN Substances</button>
          <button data-section="intelligence">Intelligence</button>
          <button data-section="planning">Planning</button>
          <button data-section="evacuation">Evacuation</button>
          <button data-section="settings">System Settings</button>
        </nav>
      </aside>

      <main class="content">
        <div class="topbar">
          <div>
            <h2 style="margin: 0 0 6px">CBRN Tactical Command System</h2>
            <div class="status-pill">Live Status 路 Updated 00:00:12</div>
          </div>
          <div class="status-group">
            <div class="status-pill">DEFCON 3 路 Round-the-clock watch</div>
            <select id="role-selector" class="role-selector" aria-label="Role selector">
              <option value="commander">Role: Commander</option>
              <option value="analyst">Role: Analyst</option>
              <option value="field">Role: Field Operator</option>
            </select>
          </div>
        </div>

        <section id="overview" class="section active">
          <div class="map-layout">
            <div>
              <div class="map-area">
                <div id="map"></div>
                <div class="map-overlay">
                  <div class="map-controls">
                    <button id="pan-mode-btn" class="map-control-btn active">Pan Mode</button>
                    <div class="map-layer-group">
                      <button id="layer-standard" class="map-control-btn active">Layer: Standard</button>
                      <button id="layer-satellite" class="map-control-btn">Layer: Satellite</button>
                      <button id="layer-terrain" class="map-control-btn">Layer: Terrain</button>
                    </div>
                    <button id="tracking-btn" class="map-control-btn active">Real-time Tracking: ON</button>
                  </div>
                </div>
                <div class="map-overlay bottom-left">
                  <div class="map-controls">
                    <button id="locate-btn" class="map-control-btn" aria-label="My Location" title="My Location"></button>
                  </div>
                </div>
                <div class="map-overlay bottom-right">
                  <div class="map-controls">
                    <button id="draw-zone-btn" class="map-control-btn">Draw Zone</button>
                    <button id="draw-evac-btn" class="map-control-btn">Draw Evac Zone</button>
                    <button id="clear-zones-btn" class="map-control-btn danger">Clear Zones</button>
                    <button id="toggle-trails-btn" class="map-control-btn">Show Trails</button>
                  </div>
                </div>
              </div>
              <div class="grid three" style="margin-top: 16px">
                <div class="panel">
                  <h3>Overlay Zones</h3>
                  <div class="chips">
                    <span class="chip">Risk Zone A-12</span>
                    <span class="chip">POI: Lab Complex</span>
                    <span class="chip">Alert Zone: C-03</span>
                    <span class="chip">Movement Pattern Grid</span>
                  </div>
                </div>
                <div class="panel">
                  <h3>Active Alerts</h3>
                  <div class="list">
                      <div class="list-item">
                        <span class="severity"><span class="dot critical"></span>Critical</span>
                        <span>02</span>
                      </div>
                      <div class="list-item">
                        <span class="severity"><span class="dot high"></span>High</span>
                        <span>04</span>
                      </div>
                      <div class="list-item">
                        <span class="severity"><span class="dot medium"></span>Medium</span>
                        <span>11</span>
                      </div>
                      <div class="list-item">
                        <span class="severity"><span class="dot low"></span>Low</span>
                        <span>23</span>
                      </div>
                    </div>
                  </div>
                  <div class="panel">
                    <h3>Active Units</h3>
                    <div class="list">
                      <div class="list-item">
                        <span>UAV-ALPHA-1</span>
                        <span class="badge">Active</span>
                      </div>
                      <div class="list-item">
                        <span>UGV-DELTA-2</span>
                        <span class="badge">Returning</span>
                      </div>
                      <div class="list-item">
                        <span>UAV-BRAVO-1</span>
                        <span class="badge">Idle</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="grid three" style="margin-top: 16px">
                  <div class="panel">
                    <h3>Incident Marker Workflow</h3>
                    <div class="panel-actions" style="margin-bottom: 8px">
                      <select id="incident-severity" class="btn" aria-label="Incident severity">
                        <option value="critical">Severity: Critical</option>
                        <option value="high">Severity: High</option>
                        <option value="medium">Severity: Medium</option>
                        <option value="low">Severity: Low</option>
                      </select>
                      <button id="incident-mode-btn" class="btn">Add Incident</button>
                    </div>
                    <input id="incident-note" class="btn" style="width: 100%" placeholder="Short incident note" />
                    <div class="tag-muted" id="incident-mode-status" style="margin-top: 8px">Mode: Off</div>
                  </div>
                  <div class="panel">
                    <h3>Alert Timeline</h3>
                    <div class="panel-actions" style="margin-bottom: 8px">
                      <select id="timeline-filter" class="btn" aria-label="Alert filter">
                        <option value="all">All</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                      </select>
                    </div>
                    <div id="alert-timeline" class="timeline"></div>
                  </div>
                  <div class="panel">
                    <h3>Notification Center</h3>
                    <div class="panel-actions" style="margin-bottom: 8px">
                      <button id="notification-sound-btn" class="btn">Sound: On</button>
                      <button id="notification-test-btn" class="btn">Test Alert</button>
                    </div>
                    <div id="notification-list" class="notification-list"></div>
                  </div>
                </div>

                <div class="grid two" style="margin-top: 16px">
                  <div class="panel">
                    <h3>Data Export</h3>
                    <div class="panel-actions">
                      <button id="export-alerts-json" class="btn">Alerts JSON</button>
                      <button id="export-alerts-csv" class="btn">Alerts CSV</button>
                      <button id="export-units-json" class="btn">Units JSON</button>
                    </div>
                  </div>
                </div>
              </div>

            <aside class="sidebar-panel">
              <h3>Active Units & Telemetry</h3>
              <div class="telemetry">
                <div class="telemetry-item">
                  <div>
                    <strong id="unit-name">UAV-ALPHA-1</strong>
                    <div class="tag"><span id="unit-type">UAV</span> 路 <span id="unit-status">Active</span></div>
                  </div>
                  <button class="btn">Focus</button>
                </div>
                <div class="telemetry-item">
                  <span>Battery</span>
                  <strong id="telemetry-battery">98%</strong>
                </div>
                <div class="telemetry-item">
                  <span>Altitude</span>
                  <strong id="telemetry-altitude">320 m</strong>
                </div>
                <div class="telemetry-item">
                  <span>Speed</span>
                  <strong id="telemetry-speed">41 km/h</strong>
                </div>
                <div class="telemetry-item">
                  <span>Signal Strength</span>
                  <strong id="telemetry-signal">92%</strong>
                </div>
                <div class="telemetry-item">
                  <span>Unit Switcher</span>
                  <select id="unit-switcher" class="btn" style="width: 140px">
                    <option value="UAV-ALPHA-1">UAV-ALPHA-1</option>
                    <option value="UGV-DELTA-2">UGV-DELTA-2</option>
                    <option value="UAV-BRAVO-1">UAV-BRAVO-1</option>
                  </select>
                </div>
              </div>
            </aside>
          </div>
        </section>

        <section id="analysis" class="section">
          <div class="grid two">
            <div class="panel">
              <h3>Mission Performance & Operational Metrics</h3>
              <div class="grid two">
                <div class="telemetry-item"><span>Total Missions</span><strong>184</strong></div>
                <div class="telemetry-item"><span>Success Rate</span><strong>93%</strong></div>
                <div class="telemetry-item"><span>Avg Response Time</span><strong>4.6 min</strong></div>
                <div class="telemetry-item"><span>Total Distance</span><strong>8,240 km</strong></div>
              </div>
            </div>
            <div class="panel">
              <h3>Mission Distribution</h3>
              <div class="chips">
                <span class="chip">Surveillance 44%</span>
                <span class="chip">Reconnaissance 26%</span>
                <span class="chip">Search & Rescue 18%</span>
                <span class="chip">Evacuation 12%</span>
              </div>
              <p style="margin-top: 12px">Pie/Bar visualization placeholder</p>
            </div>
          </div>

          <div class="grid two" style="margin-top: 16px">
            <div class="panel">
              <h3>Alert Statistics</h3>
              <div class="list">
                <div class="list-item"><span class="severity"><span class="dot critical"></span>Critical</span><strong>12</strong></div>
                <div class="list-item"><span class="severity"><span class="dot high"></span>High</span><strong>25</strong></div>
                <div class="list-item"><span class="severity"><span class="dot medium"></span>Medium</span><strong>41</strong></div>
                <div class="list-item"><span class="severity"><span class="dot low"></span>Low</span><strong>78</strong></div>
              </div>
            </div>
            <div class="panel">
              <h3>Trend Analysis Charts</h3>
              <div class="list">
                <div class="list-item">CBRN Detection Trends</div>
                <div class="list-item">Alert Frequency Analysis</div>
                <div class="list-item">Robot Performance Metrics</div>
              </div>
              <p style="margin-top: 12px">Line/area chart placeholders</p>
            </div>
          </div>
        </section>

        <section id="substances" class="section">
          <div class="panel">
            <h3>CBRN Substances Database</h3>
            <div class="chips" style="margin-bottom: 12px" id="substance-tabs">
              <span class="chip active" data-category="all">All</span>
              <span class="chip" data-category="chemical">Chem</span>
              <span class="chip" data-category="biological">Bio</span>
              <span class="chip" data-category="radiological">Rad</span>
              <span class="chip" data-category="nuclear">Nuc</span>
            </div>
            <div id="substance-display" class="grid two" style="margin-bottom: 16px"></div>
            <div style="margin-bottom: 14px">
              <input type="text" id="substance-search" class="btn" placeholder="Search substances..." style="width: 100%; margin-bottom: 8px" />
            </div>
            <div style="margin-top: 14px" class="map-controls">
              <input type="file" id="import-file" style="display: none" accept=".json" />
              <button id="import-btn">Import</button>
              <button id="export-btn">Export</button>
              <button id="add-substance-btn">Add Substance</button>
            </div>
          </div>

          <div id="add-substance-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 20px; overflow-y: auto">
            <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 500px; margin: 50px auto">
              <h3 style="margin-top: 0">Add New Substance</h3>
              <div style="display: grid; gap: 12px">
                <input type="text" id="substance-name" class="btn" placeholder="Substance Name" />
                <select id="substance-category" class="btn">
                  <option value="chemical">Chemical</option>
                  <option value="biological">Biological</option>
                  <option value="radiological">Radiological</option>
                  <option value="nuclear">Nuclear</option>
                </select>
                <input type="text" id="substance-properties" class="btn" placeholder="Properties (comma separated)" />
                <textarea id="substance-description" class="btn" placeholder="Description" style="min-height: 80px; padding: 8px"></textarea>
                <div style="display: flex; gap: 8px">
                  <button id="save-substance" class="btn" style="flex: 1">Save</button>
                  <button id="cancel-substance" class="btn" style="flex: 1">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="intelligence" class="section">
          <div class="grid two">
            <div class="panel">
              <h3>DEFCON Level Control</h3>
              <div class="list">
                <div class="list-item">Current Level: DEFCON 3 <span class="badge">Round-the-clock watch</span></div>
                <div class="list-item">Level Selector: DEFCON 1 - 5</div>
              </div>
            </div>
            <div class="panel">
              <h3>Intelligence Sources</h3>
              <div class="list">
                <div class="list-item">Satellite KH-11 路 Live feed</div>
                <div class="list-item">Local Asset - 7 路 Field report</div>
                <div class="list-item">SIGINT Node-3 路 Threat chatter</div>
              </div>
            </div>
          </div>

          <div class="grid two" style="margin-top: 16px">
            <div class="panel">
              <h3>Target Identification</h3>
              <table class="table">
                <thead>
                  <tr>
                    <th>Target</th>
                    <th>Type</th>
                    <th>Priority</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Target-21</td>
                    <td>Vehicle</td>
                    <td>PRIMARY</td>
                    <td>
                      <button class="btn">Identify</button>
                      <button class="btn">Engage</button>
                      <button class="btn">Track</button>
                    </td>
                  </tr>
                  <tr>
                    <td>Target-07</td>
                    <td>Person</td>
                    <td>SECONDARY</td>
                    <td>
                      <button class="btn">Identify</button>
                      <button class="btn">Engage</button>
                      <button class="btn">Track</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="panel">
              <h3>Intel Timeline</h3>
              <div class="list">
                <div class="list-item">12:01:22 路 Satellite KH-11 detected movement</div>
                <div class="list-item">12:03:10 路 UAV-ALPHA-1 confirmed CBRN plume</div>
                <div class="list-item">12:05:18 路 Alert Level elevated to High</div>
              </div>
            </div>
          </div>
        </section>

        <section id="planning" class="section">
          <div class="grid two">
            <div class="panel">
              <h3>Mission Templates</h3>
              <div class="list">
                <div class="list-item">Surveillance 路 3 UAV + 2 UGV 路 Risk: Medium</div>
                <div class="list-item">Extraction 路 2 UGV + Support 路 Risk: High</div>
                <div class="list-item">Reconnaissance 路 2 UAV 路 Risk: Low</div>
                <div class="list-item">Search & Rescue 路 4 UAV + 3 UGV 路 Risk: High</div>
              </div>
            </div>
            <div class="panel">
              <h3>Planner & Waypoints</h3>
              <div class="list">
                <div class="list-item">Mission Name: CBRN Sweep Sector 4</div>
                <div class="list-item">Priority: High</div>
                <div class="list-item">Waypoints: Lat/Lon input or map click</div>
                <div class="list-item">Route Preview: Active</div>
              </div>
            </div>
          </div>

          <div class="grid three" style="margin-top: 16px">
            <div class="panel">
              <h3>Mission Playbooks</h3>
              <div class="panel-actions">
                <button class="btn">Evacuation</button>
                <button class="btn">Decontamination</button>
                <button class="btn">Triage</button>
                <button class="btn">Perimeter Lockdown</button>
              </div>
            </div>
            <div class="panel">
              <h3>Playbook Checklist</h3>
              <div class="list">
                <div class="list-item">Stage Units & Assets</div>
                <div class="list-item">Confirm Wind + Spread Models</div>
                <div class="list-item">Broadcast Public Alert</div>
                <div class="list-item">Activate Decon Corridors</div>
              </div>
            </div>
            <div class="panel">
              <h3>Rules of Engagement</h3>
              <div class="list">
                <div class="list-item">Restricted Airspace: On</div>
                <div class="list-item">Drone Autonomy: Limited</div>
                <div class="list-item">Civilian Proximity: 1 km</div>
              </div>
            </div>
          </div>

          <div class="grid two" style="margin-top: 16px">
            <div class="panel">
              <h3>Routes (Mission Queue)</h3>
              <div class="list">
                <div class="list-item">Mission-Delta 路 Scheduled <button class="btn">Edit</button> <button class="btn">Launch</button></div>
                <div class="list-item">Mission-Theta 路 Ready <button class="btn">Edit</button> <button class="btn">Launch</button></div>
              </div>
            </div>
            <div class="panel">
              <h3>Resources (Fleet)</h3>
              <div class="list">
                <div class="list-item">UAV Fleet: Alpha-1, Bravo-1 路 Available</div>
                <div class="list-item">UGV Fleet: Delta-2, Foxtrot-1 路 Standby</div>
                <div class="list-item">Support: Command Center, Ambulance, Decon Unit</div>
              </div>
            </div>
          </div>
        </section>

        <section id="evacuation" class="section">
          <div class="grid four">
            <div class="panel">
              <h3>Evacuation Summary</h3>
              <div class="list">
                <div class="list-item">Zones Requiring Evacuation <strong>5</strong></div>
                <div class="list-item">Active Routes <strong>12</strong></div>
                <div class="list-item">People Evacuated <strong>4,280</strong></div>
                <div class="list-item">Assembly Points <strong>9</strong></div>
              </div>
            </div>
            <div class="panel">
              <h3>Evacuation Zones</h3>
              <div class="list">
                <div class="list-item">Zone A-12 路 120,000 m虏 路 1,250 people <button class="btn">View Map</button></div>
                <div class="list-item">Zone B-08 路 80,000 m虏 路 860 people <button class="btn">Manage Route</button></div>
              </div>
            </div>
            <div class="panel">
              <h3>Evacuation Routes</h3>
              <div class="list">
                <div class="list-item">Route Delta-3 路 Active 路 ETA 22 min <button class="btn">Pause</button></div>
                <div class="list-item">Route Echo-1 路 Active 路 ETA 18 min <button class="btn">Pause</button></div>
              </div>
            </div>
            <div class="panel">
              <h3>Assembly Points</h3>
              <div class="list">
                <div class="list-item">Point K-9 路 78% Occupied 路 Medical/Water</div>
                <div class="list-item">Point L-2 路 54% Occupied 路 Food/Shelter</div>
              </div>
            </div>
          </div>

          <div class="grid two" style="margin-top: 16px">
            <div class="panel">
              <h3>Status Tracker</h3>
              <div class="list">
                <div class="list-item">Status: In Progress</div>
                <div class="list-item">Evacuated: 4,280</div>
                <div class="list-item">In Transit: 1,140</div>
                <div class="list-item">Remaining: 620</div>
              </div>
            </div>
            <div class="panel">
              <h3>Critical Controls</h3>
              <div class="list">
                <div class="list-item">Emergency Broadcast <button class="btn danger">Activate</button></div>
                <div class="list-item">New Route Creation <button class="btn">Create</button></div>
                <div class="list-item">Sensor Integration <span class="badge">Enabled</span></div>
                <div class="list-item">Population Sync <span class="badge">Real-time</span></div>
              </div>
            </div>
          </div>
        </section>

        <section id="settings" class="section">
          <div class="grid two">
            <div class="panel">
              <h3>Profile</h3>
              <div class="list">
                <div class="list-item">Username: admin.cbrn</div>
                <div class="list-item">Display Name: Command Lead</div>
                <div class="list-item">Email: admin@cbrn-command.gov</div>
                <div class="list-item">Audit Trail: Enabled</div>
              </div>
            </div>
            <div class="panel">
              <h3>Notifications</h3>
              <div class="list">
                <div class="list-item">Alerts <span class="badge">On</span></div>
                <div class="list-item">Sound <span class="badge">On</span></div>
                <div class="list-item">Vibration <span class="badge">Off</span></div>
                <div class="list-item">Severity Threshold: High Priority</div>
              </div>
            </div>
          </div>

          <div class="grid two" style="margin-top: 16px">
            <div class="panel">
              <h3>Map Customization</h3>
              <div class="list">
                <div class="list-item">Base Layer: OpenStreetMap</div>
                <div class="list-item">Custom Markers: Enabled</div>
                <div class="list-item">Overlay Layers: Robot Positions, Alert Zones, Movement Patterns, Grid</div>
              </div>
            </div>
            <div class="panel">
              <h3>System Configuration</h3>
              <div class="list">
                <div class="list-item">Refresh Rate: 250 ms</div>
                <div class="list-item">Data Retention: 90 days</div>
                <div class="list-item">Archive Enabled: Yes</div>
                <div class="list-item">Theme: Tactical Green</div>
                <div class="list-item">Language: English</div>
              </div>
            </div>
          </div>

          <div class="grid two" style="margin-top: 16px">
            <div class="panel">
              <h3>Security</h3>
              <div class="list">
                <div class="list-item">2FA <span class="badge">Enabled</span></div>
                <div class="list-item">Session Timeout: 15 min</div>
                <div class="list-item">IP Whitelist: Active</div>
              </div>
            </div>
            <div class="panel">
              <h3>Danger Zone</h3>
              <div class="list">
                <div class="list-item">Reset All Settings <button class="btn danger">Reset</button></div>
                <div class="list-item">Clear All Data <button class="btn danger">Clear</button></div>
              </div>
              <p style="margin-top: 10px">Admin-only. Changes applied immediately.</p>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      // Mock unit data
      const unitData = {
        'UAV-ALPHA-1': {
          type: 'UAV',
          status: 'Active',
          battery: '98%',
          altitude: '320 m',
          speed: '41 km/h',
          signal: '92%'
        },
        'UGV-DELTA-2': {
          type: 'UGV',
          status: 'Active',
          battery: '87%',
          altitude: 'N/A',
          speed: '18 km/h',
          signal: '78%'
        },
        'UAV-BRAVO-1': {
          type: 'UAV',
          status: 'Standby',
          battery: '65%',
          altitude: '215 m',
          speed: 'Hovering',
          signal: '85%'
        }
      };

      const alertTimelineData = [
        { id: 1, severity: 'critical', message: 'Chlorine plume detected 路 Sector A-12', time: '00:00:32' },
        { id: 2, severity: 'high', message: 'UGV-DELTA-2 gas spike 路 Lab perimeter', time: '00:01:05' },
        { id: 3, severity: 'medium', message: 'UAV-BRAVO-1 thermal anomaly 路 Grid C-03', time: '00:02:11' },
        { id: 4, severity: 'low', message: 'Perimeter motion sensor 路 East gate', time: '00:03:44' }
      ];

      const notificationData = [
        { id: 1, message: 'System check complete', time: '00:00:15' },
        { id: 2, message: 'Evacuation update synced', time: '00:01:40' }
      ];

      const defaultSubstances = {
        chemical: [
          { name: 'Sarin', properties: 'Liquid, Volatile, Lethal', description: 'Organophosphate nerve agent' },
          { name: 'Soman', properties: 'Liquid, Persistent, Lethal', description: 'Binary nerve agent' },
          { name: 'VX', properties: 'Oily, Very Persistent, Lethal', description: 'Most lethal nerve agent' },
          { name: 'Chlorine Gas', properties: 'Gas, Reactive, Toxic', description: 'Pulmonary agent' }
        ],
        biological: [
          { name: 'Anthrax', properties: 'Spore, Persistent, Lethal', description: 'Bacillus anthracis' },
          { name: 'Smallpox', properties: 'Virus, Highly Contagious, Lethal', description: 'Variola virus' },
          { name: 'Plague', properties: 'Bacterial, Infectious, High Mortality', description: 'Yersinia pestis' },
          { name: 'Ebola', properties: 'Virus, Highly Lethal, Hemorrhagic', description: 'Filovirus' }
        ],
        radiological: [
          { name: 'Cesium-137', properties: 'Beta emitter, 30 year half-life', description: 'Fission product' },
          { name: 'Cobalt-60', properties: 'Gamma emitter, 5.3 year half-life', description: 'Activation product' },
          { name: 'Iridium-192', properties: 'Gamma emitter, 73.8 day half-life', description: 'Medical isotope' }
        ],
        nuclear: [
          { name: 'Uranium-235', properties: 'Fissile, Alpha emitter', description: 'Natural uranium isotope' },
          { name: 'Plutonium-239', properties: 'Fissile, Alpha emitter, 24,000 year half-life', description: 'Weapons material' },
          { name: 'Uranium Hexafluoride', properties: 'Corrosive, Reactive gas', description: 'Uranium enrichment feedstock' }
        ]
      };

      let substanceDatabase = JSON.parse(JSON.stringify(defaultSubstances));
      let currentSubstanceFilter = 'all';

      let currentTileLayer = null;
      let userLocationMarker = null;
      let drawnItems = null;
      let drawHandlers = {};
      let incidentMode = false;
      let trailLayers = [];
      let trailsVisible = false;
      let notificationsSoundEnabled = true;

      // Initialize Leaflet map after DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        let map = window.map = L.map('map').setView([51.505, -0.09], 13);
        currentTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '漏 OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);
        
        // Force map to recalculate size
        setTimeout(() => map.invalidateSize(), 100);

        drawnItems = new L.FeatureGroup();
        window.map.addLayer(drawnItems);
        const drawControl = new L.Control.Draw({
          edit: { featureGroup: drawnItems },
          draw: {
            polygon: true,
            rectangle: true,
            polyline: false,
            circle: false,
            marker: false,
            circlemarker: false
          }
        });
        window.map.addControl(drawControl);

        window.map.on(L.Draw.Event.CREATED, (event) => {
          drawnItems.addLayer(event.layer);
        });

        drawHandlers = {
          polygon: new L.Draw.Polygon(window.map, drawControl.options.draw.polygon),
          rectangle: new L.Draw.Rectangle(window.map, drawControl.options.draw.rectangle)
        };

        // Locate current user position
        const locateBtn = document.getElementById('locate-btn');
        if (locateBtn) {
          locateBtn.addEventListener('click', () => {
            window.map.locate({ setView: true, maxZoom: 16 });
          });
        }

        window.map.on('locationfound', (e) => {
          if (userLocationMarker) {
            userLocationMarker.setLatLng(e.latlng);
          } else {
            userLocationMarker = L.marker(e.latlng).addTo(window.map);
          }
          setTimeout(() => window.map.invalidateSize(), 100);
        });

        window.map.on('locationerror', () => {
          if (locateBtn) {
            locateBtn.textContent = '锔';
            setTimeout(() => {
              locateBtn.textContent = '';
            }, 2000);
          }
        });

        window.map.on('click', (event) => {
          if (!incidentMode) return;
          const severity = document.getElementById('incident-severity').value;
          const note = document.getElementById('incident-note').value || 'Incident reported';
          const colors = {
            critical: '#ff4d4f',
            high: '#ffb020',
            medium: '#ffd166',
            low: '#38ff9c'
          };
          const marker = L.circleMarker(event.latlng, {
            radius: 8,
            color: colors[severity],
            fillColor: colors[severity],
            fillOpacity: 0.9
          }).addTo(window.map);
          marker.bindPopup(`<strong>${severity.toUpperCase()}</strong><br/>${note}`).openPopup();
          incidentMode = false;
          const incidentStatus = document.getElementById('incident-mode-status');
          const incidentBtn = document.getElementById('incident-mode-btn');
          incidentStatus.textContent = 'Mode: Off';
          incidentBtn.classList.remove('active');
        });
      });

      const buttons = document.querySelectorAll(".nav button");
      const sections = document.querySelectorAll(".section");

      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          buttons.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");
          const target = button.dataset.section;
          sections.forEach((section) => {
            section.classList.toggle("active", section.id === target);
          });
          // Refresh map size when switching sections
          if (target === "overview" && window.map) {
            setTimeout(() => window.map.invalidateSize(), 100);
          }
        });
      });

      // Unit Switcher functionality
      const unitSwitcher = document.getElementById('unit-switcher');
      if (unitSwitcher) {
        unitSwitcher.addEventListener('change', (e) => {
          const unitName = e.target.value;
          const data = unitData[unitName];
          
          document.getElementById('unit-name').textContent = unitName;
          document.getElementById('unit-type').textContent = data.type;
          document.getElementById('unit-status').textContent = data.status;
          document.getElementById('telemetry-battery').textContent = data.battery;
          document.getElementById('telemetry-altitude').textContent = data.altitude;
          document.getElementById('telemetry-speed').textContent = data.speed;
          document.getElementById('telemetry-signal').textContent = data.signal;
        });
      }

      // Role selector
      const roleSelector = document.getElementById('role-selector');
      if (roleSelector) {
        document.body.dataset.role = roleSelector.value;
        roleSelector.addEventListener('change', (e) => {
          document.body.dataset.role = e.target.value;
          addNotification(`Role switched to ${e.target.options[e.target.selectedIndex].text}`);
        });
      }

      // Alert timeline
      const alertTimeline = document.getElementById('alert-timeline');
      const timelineFilter = document.getElementById('timeline-filter');

      function renderTimeline(filter = 'all') {
        if (!alertTimeline) return;
        alertTimeline.innerHTML = '';
        alertTimelineData
          .filter(item => filter === 'all' || item.severity === filter)
          .forEach(item => {
            const row = document.createElement('div');
            row.className = 'timeline-item';
            row.innerHTML = `
              <div>
                <strong>${item.message}</strong>
                <div class="timeline-meta">${item.severity.toUpperCase()}</div>
              </div>
              <div class="timeline-meta">${item.time}</div>
            `;
            alertTimeline.appendChild(row);
          });
      }

      if (timelineFilter) {
        timelineFilter.addEventListener('change', (e) => renderTimeline(e.target.value));
      }
      renderTimeline('all');

      // Notifications
      const notificationList = document.getElementById('notification-list');
      const notificationSoundBtn = document.getElementById('notification-sound-btn');
      const notificationTestBtn = document.getElementById('notification-test-btn');

      function renderNotifications() {
        if (!notificationList) return;
        notificationList.innerHTML = '';
        notificationData.slice(0, 5).forEach(item => {
          const row = document.createElement('div');
          row.className = 'notification-item';
          row.innerHTML = `<span>${item.message}</span><span class="timeline-meta">${item.time}</span>`;
          notificationList.appendChild(row);
        });
      }

      function playNotificationSound() {
        if (!notificationsSoundEnabled) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const oscillator = ctx.createOscillator();
        const gain = ctx.createGain();
        oscillator.connect(gain);
        gain.connect(ctx.destination);
        oscillator.type = 'sine';
        oscillator.frequency.value = 740;
        gain.gain.value = 0.05;
        oscillator.start();
        oscillator.stop(ctx.currentTime + 0.2);
      }

      function addNotification(message) {
        notificationData.unshift({
          id: Date.now(),
          message,
          time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })
        });
        renderNotifications();
        playNotificationSound();
      }

      if (notificationSoundBtn) {
        notificationSoundBtn.addEventListener('click', () => {
          notificationsSoundEnabled = !notificationsSoundEnabled;
          notificationSoundBtn.textContent = `Sound: ${notificationsSoundEnabled ? 'On' : 'Off'}`;
        });
      }

      if (notificationTestBtn) {
        notificationTestBtn.addEventListener('click', () => {
          addNotification('Test alert dispatched');
        });
      }

      renderNotifications();

      // Incident marker workflow
      const incidentModeBtn = document.getElementById('incident-mode-btn');
      const incidentStatus = document.getElementById('incident-mode-status');
      if (incidentModeBtn && incidentStatus) {
        incidentModeBtn.addEventListener('click', () => {
          incidentMode = !incidentMode;
          incidentModeBtn.classList.toggle('active', incidentMode);
          incidentStatus.textContent = incidentMode ? 'Mode: Click map to place' : 'Mode: Off';
        });
      }

      // Map tools (drawing + trails)
      const drawZoneBtn = document.getElementById('draw-zone-btn');
      const drawEvacBtn = document.getElementById('draw-evac-btn');
      const clearZonesBtn = document.getElementById('clear-zones-btn');
      const toggleTrailsBtn = document.getElementById('toggle-trails-btn');

      if (drawZoneBtn) {
        drawZoneBtn.addEventListener('click', () => drawHandlers.polygon && drawHandlers.polygon.enable());
      }
      if (drawEvacBtn) {
        drawEvacBtn.addEventListener('click', () => drawHandlers.rectangle && drawHandlers.rectangle.enable());
      }
      if (clearZonesBtn) {
        clearZonesBtn.addEventListener('click', () => drawnItems && drawnItems.clearLayers());
      }

      const unitTrails = {
        'UAV-ALPHA-1': [[51.505, -0.09], [51.507, -0.095], [51.508, -0.085]],
        'UGV-DELTA-2': [[51.503, -0.08], [51.502, -0.083], [51.500, -0.086]],
        'UAV-BRAVO-1': [[51.509, -0.1], [51.512, -0.104], [51.514, -0.098]]
      };

      function toggleTrails() {
        if (!window.map) return;
        trailsVisible = !trailsVisible;
        if (toggleTrailsBtn) {
          toggleTrailsBtn.textContent = trailsVisible ? 'Hide Trails' : 'Show Trails';
        }
        if (!trailsVisible) {
          trailLayers.forEach(layer => window.map.removeLayer(layer));
          trailLayers = [];
          return;
        }
        trailLayers = Object.keys(unitTrails).map((key, index) => {
          const color = ['#38ff9c', '#ffb020', '#00d4ff'][index % 3];
          return L.polyline(unitTrails[key], { color, weight: 3 }).addTo(window.map);
        });
      }

      if (toggleTrailsBtn) {
        toggleTrailsBtn.addEventListener('click', toggleTrails);
      }

      // Data export
      function downloadFile(filename, content, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      }

      const exportAlertsJson = document.getElementById('export-alerts-json');
      const exportAlertsCsv = document.getElementById('export-alerts-csv');
      const exportUnitsJson = document.getElementById('export-units-json');

      if (exportAlertsJson) {
        exportAlertsJson.addEventListener('click', () => {
          downloadFile('alerts.json', JSON.stringify(alertTimelineData, null, 2), 'application/json');
        });
      }

      if (exportAlertsCsv) {
        exportAlertsCsv.addEventListener('click', () => {
          const csv = ['id,severity,message,time']
            .concat(alertTimelineData.map(item => `${item.id},${item.severity},"${item.message}",${item.time}`))
            .join('\n');
          downloadFile('alerts.csv', csv, 'text/csv');
        });
      }

      if (exportUnitsJson) {
        exportUnitsJson.addEventListener('click', () => {
          downloadFile('units.json', JSON.stringify(unitData, null, 2), 'application/json');
        });
      }

      // Map Layer Switching
      const tileLayerOptions = {
        standard: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        terrain: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'
      };

      const layerButtons = {
        standard: document.getElementById('layer-standard'),
        satellite: document.getElementById('layer-satellite'),
        terrain: document.getElementById('layer-terrain')
      };

      function switchLayer(layerType) {
        if (window.map && currentTileLayer) {
          window.map.removeLayer(currentTileLayer);
        }
        
        const attribution = layerType === 'standard' 
          ? '漏 OpenStreetMap contributors'
          : layerType === 'satellite'
          ? '漏 Esri'
          : '漏 OpenTopoMap';

        currentTileLayer = L.tileLayer(tileLayerOptions[layerType], {
          attribution: attribution,
          maxZoom: 19
        }).addTo(window.map);

        // Update button states
        Object.keys(layerButtons).forEach(key => {
          layerButtons[key].classList.remove('active');
        });
        layerButtons[layerType].classList.add('active');
      }

      // Layer button event listeners
      document.getElementById('layer-standard').addEventListener('click', () => switchLayer('standard'));
      document.getElementById('layer-satellite').addEventListener('click', () => switchLayer('satellite'));
      document.getElementById('layer-terrain').addEventListener('click', () => switchLayer('terrain'));

      // Pan Mode toggle
      let panModeEnabled = true;
      document.getElementById('pan-mode-btn').addEventListener('click', (e) => {
        panModeEnabled = !panModeEnabled;
        e.target.classList.toggle('active');
        if (window.map) {
          window.map.dragging[panModeEnabled ? 'enable' : 'disable']();
        }
      });

      // Real-time Tracking toggle
      let trackingEnabled = true;
      document.getElementById('tracking-btn').addEventListener('click', (e) => {
        trackingEnabled = !trackingEnabled;
        e.target.classList.toggle('active');
        e.target.textContent = `Real-time Tracking: ${trackingEnabled ? 'ON' : 'OFF'}`;
      });

      // Substance Database functions
      function renderSubstances(filter = 'all', searchTerm = '') {
        const display = document.getElementById('substance-display');
        if (!display) return;
        display.innerHTML = '';

        let categoriesToShow = [];
        if (filter === 'all') {
          categoriesToShow = Object.keys(substanceDatabase);
        } else {
          categoriesToShow = [filter];
        }

        categoriesToShow.forEach(category => {
          const categoryLabel = category.charAt(0).toUpperCase() + category.slice(1);
          const substances = substanceDatabase[category]
            .filter(s => !searchTerm || s.name.toLowerCase().includes(searchTerm.toLowerCase()))
            .sort((a, b) => a.name.localeCompare(b.name));

          if (substances.length === 0) return;

          const panel = document.createElement('div');
          panel.className = 'panel';
          panel.innerHTML = `<h3>${categoryLabel} (${substances.length})</h3>`;

          const list = document.createElement('div');
          list.className = 'list';
          substances.forEach(substance => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.style.flexDirection = 'column';
            item.style.alignItems = 'flex-start';
            item.innerHTML = `
              <strong>${substance.name}</strong>
              <div class="timeline-meta" style="margin-top: 4px">${substance.properties}</div>
              <div class="timeline-meta" style="margin-top: 4px">${substance.description}</div>
            `;
            list.appendChild(item);
          });

          panel.appendChild(list);
          display.appendChild(panel);
        });
      }

      // Substance UI handlers
      const substanceTabs = document.getElementById('substance-tabs');
      const substanceSearch = document.getElementById('substance-search');
      const importBtn = document.getElementById('import-btn');
      const exportBtn = document.getElementById('export-btn');
      const addSubstanceBtn = document.getElementById('add-substance-btn');
      const importFile = document.getElementById('import-file');
      const addSubstanceModal = document.getElementById('add-substance-modal');
      const saveSubstanceBtn = document.getElementById('save-substance');
      const cancelSubstanceBtn = document.getElementById('cancel-substance');

      if (substanceTabs) {
        substanceTabs.addEventListener('click', (e) => {
          if (e.target.classList.contains('chip')) {
            document.querySelectorAll('#substance-tabs .chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            currentSubstanceFilter = e.target.dataset.category;
            renderSubstances(currentSubstanceFilter, substanceSearch?.value || '');
          }
        });
      }

      if (substanceSearch) {
        substanceSearch.addEventListener('input', () => {
          renderSubstances(currentSubstanceFilter, substanceSearch.value);
        });
      }

      if (importBtn) {
        importBtn.addEventListener('click', () => importFile.click());
      }

      if (importFile) {
        importFile.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const imported = JSON.parse(event.target.result);
              substanceDatabase = imported;
              renderSubstances(currentSubstanceFilter);
              addNotification('Substances imported successfully');
            } catch (err) {
              addNotification('Error importing substances');
            }
          };
          reader.readAsText(file);
        });
      }

      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          downloadFile('substances.json', JSON.stringify(substanceDatabase, null, 2), 'application/json');
          addNotification('Substances exported');
        });
      }

      if (addSubstanceBtn) {
        addSubstanceBtn.addEventListener('click', () => {
          addSubstanceModal.style.display = 'block';
        });
      }

      if (cancelSubstanceBtn) {
        cancelSubstanceBtn.addEventListener('click', () => {
          addSubstanceModal.style.display = 'none';
          document.getElementById('substance-name').value = '';
          document.getElementById('substance-properties').value = '';
          document.getElementById('substance-description').value = '';
        });
      }

      if (saveSubstanceBtn) {
        saveSubstanceBtn.addEventListener('click', () => {
          const name = document.getElementById('substance-name').value;
          const category = document.getElementById('substance-category').value;
          const properties = document.getElementById('substance-properties').value;
          const description = document.getElementById('substance-description').value;

          if (!name || !properties || !description) {
            addNotification('Please fill in all fields');
            return;
          }

          substanceDatabase[category].push({ name, properties, description });
          renderSubstances(currentSubstanceFilter);
          addSubstanceModal.style.display = 'none';
          document.getElementById('substance-name').value = '';
          document.getElementById('substance-properties').value = '';
          document.getElementById('substance-description').value = '';
          addNotification(`Substance "${name}" added to ${category}`);
        });
      }

      // Initial render
      renderSubstances('all');
    </script>
  </body>
</html>
